<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Live Stream Viewer</title>
    <style>
        #liveIndicator {
            display: none;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>WebSocket Live Stream Viewer</h1>
    <video id="videoPlayer" controls width="640" height="360"></video>
    <div id="liveIndicator">LIVE</div>
    <div id="status"></div>

    <script>
        const video = document.getElementById('videoPlayer');
        const liveIndicator = document.getElementById('liveIndicator');
        const status = document.getElementById('status');
        const websocketUrl = 'ws://localhost:9501';  // Ganti dengan URL WebSocket Anda

        let mediaSource;
        let sourceBuffer;
        let queue = [];
        let isBufferUpdating = false;

        function initMediaSource() {
            mediaSource = new MediaSource();
            video.src = URL.createObjectURL(mediaSource);

            mediaSource.addEventListener('sourceopen', function() {
                sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8,opus"');
                sourceBuffer.mode = 'segments';
                sourceBuffer.addEventListener('updateend', processQueue);
                connectWebSocket();
            });
        }

        function connectWebSocket() {
            const socket = new WebSocket(websocketUrl);
            socket.binaryType = 'arraybuffer';

            socket.onopen = function() {
                status.textContent = 'WebSocket Connected';
                liveIndicator.style.display = 'block';
            };

            socket.onmessage = function(event) {
                if (event.data instanceof ArrayBuffer) {
                    queue.push(event.data);
                    processQueue();
                }
            };

            socket.onerror = function(error) {
                console.error('WebSocket Error:', error);
                status.textContent = 'WebSocket Error';
            };

            socket.onclose = function() {
                status.textContent = 'WebSocket Closed';
                liveIndicator.style.display = 'none';
            };
        }

        function processQueue() {
            if (!sourceBuffer || isBufferUpdating || queue.length === 0) {
                return;
            }

            isBufferUpdating = true;
            const data = queue.shift();
            sourceBuffer.appendBuffer(data);
        }

        sourceBuffer.addEventListener('updateend', function() {
            isBufferUpdating = false;
            processQueue();
        });

        video.addEventListener('canplay', function() {
            video.play();
        });

        initMediaSource();
    </script>
</body>
</html>